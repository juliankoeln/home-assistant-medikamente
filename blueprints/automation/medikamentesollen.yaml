blueprint:
  name: üíä Medikamenten-Erinnerung mit Bestand und Push
  description: >
    Erinnerung zur Einnahme, Counter f√ºr Bestand,
    Button "Eingenommen", Warnung bei niedrigem Bestand.
  domain: automation

  input:
    med_name:
      name: Medikamentenname
      selector:
        text:

    med_counter:
      name: Bestandsz√§hler
      selector:
        entity:
          domain: counter

    dosis:
      name: Dosierung pro Einnahme
      selector:
        number:
          min: 1
          max: 10

    warnwert:
      name: Warnschwelle
      selector:
        number:
          min: 0
          max: 50

    erinnerungszeit:
      name: Einnahmezeit
      selector:
        time:

    notify_device:
      name: Ger√§t f√ºr Benachrichtigung
      selector:
        device:
          integration: mobile_app

trigger:
  - platform: time
    at: !input erinnerungszeit

mode: restart

action:
  # Push-Erinnerung mit Buttons
  - service: notify.mobile_app
    data:
      target:
        - !input notify_device
      title: "üíä {{ !input med_name }}"
      message: "Bitte die Einnahme best√§tigen"
      data:
        actions:
          - action: taken
            title: "Eingenommen"
          - action: later
            title: "Sp√§ter erinnern"

  # Warten auf Button-Klick
  - wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action

  # Verarbeiten des Buttons
  - choose:
      # Eingenommen ‚Üí Counter abziehen
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == 'taken' }}"
        sequence:
          - repeat:
              count: !input dosis
              sequence:
                - service: counter.decrement
                  target:
                    entity_id: !input med_counter

      # Sp√§ter erinnern ‚Üí Push erneut nach 15 Minuten
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == 'later' }}"
        sequence:
          - delay: "00:15:00"
          - service: notify.mobile_app
            data:
              target:
                - !input notify_device
              title: "üíä Erinnerung"
              message: "Bitte die Einnahme best√§tigen"

  # Warnung, falls Bestand niedrig
  - condition: numeric_state
    entity_id: !input med_counter
    below: !input warnwert
  - service: notify.notify
    data:
      title: "‚ö†Ô∏è Medikament fast leer"
      message: "{{ !input med_name }} nur noch {{ states(!input med_counter) | int }} Tabletten"
